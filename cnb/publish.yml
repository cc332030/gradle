
jdk-version-runner: 25

.publish: &publish
  - env:
      JDK_VERSION_RUNNER: !reference [jdk-version-runner]
    if: |
      [[ "${JDK_VERSION_DEFINE}" == "${JDK_VERSION_COMPILE}" \
        && ("${CNB_EVENT}"=="tag_push" \
            || ("${CNB_EVENT}"=="push" \
                && ("${CNB_BRANCH}"=="master" || "${CNB_BRANCH}"=="main")
        )
      ]]
    services:
      - docker
    docker:
      image: ibm-semeru-runtimes:open-${JDK_VERSION_RUNNER}-jdk
      volumes:
        - gradle-wrapper:/root/.gradle/wrapper:copy-on-write
        - gradle-jdks:/root/.gradle/jdks:copy-on-write
        - ${CNB_REPO_NAME}-${JDK_VERSION_COMPILE}:/root/.gradle/caches:copy-on-write
    stages:
      - name: init
        script: |
          mkdir -p ~/.gradle
          curl -sLO \
            --output-dir ~/.gradle \
            https://github.com/cc332030/gradle/raw/refs/heads/master/conf/init.gradle.kts
      - name: publish
        imports: https://cnb.cool/${CNB_GROUP_SLUG}/secrets/-/blob/main/secrets.yml
        script: |
          sh gradlew --stacktrace clean publish
        env:
          JDK_VERSION: ${JDK_VERSION_COMPILE}

          NEXUS_ID: ${CNB_GROUP_SLUG}
          MAVEN_CENTRAL: https://mirrors.cloud.tencent.com/nexus/repository/maven-public/
          NEXUS_USERNAME: ${CNB_TOKEN_USER_NAME}
          NEXUS_PASSWORD: ${CNB_TOKEN_ARTIFACTORY}

          NEXUS_SNAPSHOT_ID: ${CNB_GROUP_SLUG}-snapshot
          NEXUS_SNAPSHOT_URL: https://maven.cnb.cool/${CNB_GROUP_SLUG}/maven-snapshot/-/packages/
          NEXUS_RELEASE_ID: ${CNB_GROUP_SLUG}-release
          NEXUS_RELEASE_URL: https://maven.cnb.cool/${CNB_GROUP_SLUG}/maven-release/-/packages/

$:
  (push|tag_push):
    - <<: *publish
      name: jdk-compile-25
      env:
        JDK_VERSION_DEFINE: 25
        JDK_VERSION_COMPILE: !reference [jdk-compile-25]
    - <<: *publish
      name: jdk-compile-21
      env:
        JDK_VERSION_DEFINE: 21
        JDK_VERSION_COMPILE: !reference [jdk-compile-21]
    - <<: *publish
      name: jdk-compile-17
      env:
        JDK_VERSION_DEFINE: 17
        JDK_VERSION_COMPILE: !reference [jdk-compile-17]
    - <<: *publish
      name: jdk-compile-11
      env:
        JDK_VERSION_DEFINE: 11
        JDK_VERSION_COMPILE: !reference [jdk-compile-11]
    - <<: *publish
      name: jdk-compile-8
      env:
        JDK_VERSION_DEFINE: 8
        JDK_VERSION_COMPILE: !reference [jdk-compile-8]
